     1                                  %include "init.inc"
     2                              <1> READ_CYLINDERS equ 3									; 읽을 실린더 수
     3                              <1> FLOPPY_SEGMENT equ 0x07e0								; 읽기 시작할 메모리의 세그먼트
     4                              <1> 
     5                              <1> KERNEL_ADDR equ (FLOPPY_SEGMENT * 0x10 + 0x4200 - 0x200); 커널의 위치 = 0xc000
     6                              <1> 													; = FLOPPY_SEGMENT * 0x10 + 0x4200 - 0x200
     7                              <1> ; !!주의!!
     8                              <1> ; [ 0x00080000 ~ 0x00100000 ) => 사용 불능 메모리
     9                              <1> ; [ 0x00007e00 ~ 0x00080000 ) 까지만 로드 가능
    10                              <1> ; 480.5 KiB -> 최대 26 실린더 로드 가능 (468 KiB)
    11                                  
    12                                  [org 0x7c00]
    13                                  [bits 16]
    14 00000000 EB4E                    	jmp start
    15                                  
    16                                  ; fat12 파일 시스템의 헤더
    17 00000002 00                      db 0						; fat12의 헤더가 이 다음부터 시작하기 때문에, 1byte를 넣음
    18 00000003 434C5542434F5330        db "CLUBCOS0"				; 부트섹터의 이름을 8글자로 적음
    19 0000000B 0002                    dw 512						; 1섹터의 크기(바이트 단위)
    20 0000000D 01                      db 1						; 클러스터의 크기(섹터 단위, fat12에선 1섹터
    21 0000000E 0100                    dw 1						; 예약된 섹터의 수
    22 00000010 02                      db 2						; 디스크의 FAT의 수(fat12에선 2)
    23 00000011 E000                    dw 224						; 루트 디렉터리 엔트리의 수(보통은 224엔트리)
    24 00000013 400B                    dw 2880						; 디스크의 총 섹터 수
    25 00000015 F0                      db 0xf0						; 미디어 타입(0xf0으로 해야 함)
    26 00000016 0900                    dw 9						; FAT 하나당 섹터 수(fat12에선 9)
    27 00000018 1200                    dw 18						; 1트랙당 섹터 수(플로피 디스크에선 18)
    28 0000001A 0200                    dw 2						; 헤드의 수
    29 0000001C 00000000                dd 0						; 파티션을 쓰지 않으므로 0
    30 00000020 400B0000                dd 2880						; 섹터 수를 다시 씀
    31 00000024 000029                  db 0, 0, 0x29				; 잘 모르겠습니다ㅡ.ㅡ
    32 00000027 FFFFFFFF                dd 0xffffffff				; 책에선 '아마 볼륨 시리얼 번호'라네요
    33 0000002B 434C5542434F533020-     db "CLUBCOS0   "			; 디스크의 이름(11바이트)
    34 00000034 2020               
    35 00000036 4641543132202020        db "FAT12   "				; 파일 시스템의 이름(8바이트)
    36 0000003E 00<rept>                times 18 db 0				; 18바이트 비움
    37                                  
    38                                  start:
    39 00000050 8CC8                    	mov ax, cs
    40 00000052 8ED8                    	mov ds, ax				; ds를 cs와 같게 한다
    41                                  
    42 00000054 B80000                  	mov ax, 0				; 스택을 설정한다
    43 00000057 8ED0                    	mov ss, ax				; 스택의 세그먼트 : 0
    44 00000059 BC007C                  	mov sp, 0x7c00			; 스택의 오프셋 : 0x7c00
    45                                  
    46 0000005C BE[6F00]                	mov si, boot_msg		; 부팅 메세지 출력문
    47                                  bootmsg_putloop:
    48 0000005F 8A04                    	mov al, [si]			; 메세지의 한 글자 읽음
    49 00000061 46                      	inc si					; si++
    50 00000062 3C00                    	cmp al, 0				; al과 0을 비교
    51 00000064 7437                    	je bootmsg_end			; 0이면 bootmsg_end으로 jmp
    52 00000066 B40E                    	mov ah, 0x0e			; ah=0x0e -> 화면에 한 글자 출력
    53 00000068 BB0F00                  	mov bx, 15				; 색 코드
    54 0000006B CD10                    	int 0x10				; BIOS 호출(al엔 글자 코드)
    55 0000006D EBF0                    	jmp bootmsg_putloop		; 루프를 돔
    56                                  
    57                                  boot_msg:
    58 0000006F 0A0A                    	db 0x0a, 0x0a			; 개행 ASCII 코드
    59 00000071 546869732069732043-     	db "This is Clubcos0 boot loader, booting...."
    60 0000007A 6C7562636F73302062-
    61 00000083 6F6F74206C6F616465-
    62 0000008C 722C20626F6F74696E-
    63 00000095 672E2E2E2E         
    64 0000009A 0A0D                    	db 0x0a, 0x0d
    65 0000009C 00                      	db 0					; NULL
    66                                  bootmsg_end:
    67                                  
    68 0000009D B8E007                  	mov ax, FLOPPY_SEGMENT
    69 000000A0 8EC0                    	mov es, ax				; es:bx -> 읽기 시작할 메모리의 주소(bx는 0)
    70 000000A2 B500                    	mov ch, 0				; 실린더 0
    71 000000A4 B600                    	mov dh, 0				; 헤드 0
    72 000000A6 B102                    	mov cl, 2				; 섹터 2
    73                                  readloop:
    74 000000A8 BE0000                  	mov si, 0				; 읽기 실패 횟수를 세는 레지스터
    75                                  retry:
    76 000000AB B402                    	mov ah, 0x02			; ah=2 -> 읽기
    77 000000AD B001                    	mov al, 1				; 1섹터씩 읽음
    78 000000AF BB0000                  	mov bx, 0
    79 000000B2 B200                    	mov dl, 0				; 첫번째 플로피 디스크
    80 000000B4 CD13                    	int 0x13				; BIOS 호출
    81 000000B6 730E                    	jnc next				; 성공이면 next로
    82 000000B8 46                      	inc si					; 읽기 실패 횟수 증가
    83 000000B9 83FE05                  	cmp si, 5				; si와 5를 비교
    84 000000BC 732B                    	jae error				; 5 이상이면 에러 처리
    85 000000BE B400                    	mov ah, 0				; ah=0 -> 드라이브 리셋
    86 000000C0 B600                    	mov dh, 0				; 첫번째 플로피 디스크
    87 000000C2 CD13                    	int 0x13				; BIOS 호출
    88 000000C4 EBE5                    	jmp retry				; 다시 시도
    89                                  next:
    90 000000C6 8CC0                    	mov ax, es				; es:bx에 0x200을 더함
    91 000000C8 83C020                  	add ax, 0x20			; es는 세그먼트이기 때문에 0x20을 더함
    92 000000CB 8EC0                    	mov es, ax				; es는 세그먼트이기 때문에 ax를 경유해서 계산
    93 000000CD FEC1                    	inc cl					; 섹터 번호를 1증가
    94 000000CF 80F912                  	cmp cl, 18				; cl과 18을 비교
    95 000000D2 76D4                    	jbe readloop			; 18 이하라면 readloop로 jmp
    96 000000D4 B101                    	mov cl, 1				; 18 초과라면 섹터 번호를 1로
    97 000000D6 FEC6                    	inc dh					; 그리고 헤드 번호를 1증가
    98 000000D8 80FE02                  	cmp dh, 2				; dh와 2를 비교
    99 000000DB 72CB                    	jb readloop				; 2 미만이라면 readloop로 jmp
   100 000000DD B600                    	mov dh, 0				; 2 이상이라면 dh를 0으로
   101 000000DF FEC5                    	inc ch					; 실린더 번호를 증가
   102 000000E1 80FD03                  	cmp ch, READ_CYLINDERS	; ch와 READ_CYLINDERS를 비교
   103 000000E4 72C2                    	jb readloop				; ch < READ_CYLINDERS(다 못읽었으면)
   104                                  							; readloop로 감
   105                                  
   106 000000E6 E9(00BE)                	jmp KERNEL_ADDR			; OS를 실행!
   107                                  
   108                                  error:						; 에러 처리 구문
   109 000000E9 BE[FF00]                	mov si, msg				; 에러 메세지의 주소
   110                                  putloop:
   111 000000EC 8A04                    	mov al, [si]			; 메세지의 한 글자 읽음
   112 000000EE 46                      	inc si					; si++
   113 000000EF 3C00                    	cmp al, 0				; al과 0을 비교
   114 000000F1 7409                    	je stop					; 0이면 stop으로 jmp
   115 000000F3 B40E                    	mov ah, 0x0e			; ah=0x0e -> 화면에 한 글자 출력
   116 000000F5 BB0F00                  	mov bx, 15				; 색 코드
   117 000000F8 CD10                    	int 0x10				; BIOS 호출(al엔 글자 코드)
   118 000000FA EBF0                    	jmp putloop				; 루프를 돔
   119                                  stop:
   120 000000FC F4                      	hlt						; CPU를 일시정지
   121 000000FD EBFD                    	jmp stop				; 무한루프
   122                                  
   123                                  msg:
   124 000000FF 0A0A                    	db 0x0a, 0x0a			; 개행 ASCII 코드
   125 00000101 436C7562636F733020-     	db "Clubcos0 load error, system halt"
   126 0000010A 6C6F6164206572726F-
   127 00000113 722C2073797374656D-
   128 0000011C 2068616C74         
   129 00000121 0A                      	db 0x0a
   130 00000122 00                      	db 0					; NULL
   131                                  
   132 00000123 00<rept>                times 510-($-$$) db 0
   133 000001FE 55AA                    dw 0xAA55
